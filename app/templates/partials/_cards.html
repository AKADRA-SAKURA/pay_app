<!-- カード登録（オーバーレイ） -->

<div id="card-form-template" class="overlay-form-template">
  <div class="card">
    <h2>カード登録 <span class="pill">フェーズ1</span></h2>

    {% if not accounts %}
      <div class="hint">※ 先に口座を1つ追加してください。</div>
    {% endif %}

    <form method="post" action="/cards" class="form">
      <label class="col-span-all">
        カード名
        <input name="name" placeholder="楽天カード / 三井住友" required />
      </label>

      <label>
        締日（1-31）
        <input name="closing_day" type="number" min="1" max="31" value="15" required />
      </label>

      <label>
        支払日（1-31）
        <input name="payment_day" type="number" min="1" max="31" value="10" required />
      </label>

      <label>
        有効開始日
        <input name="effective_start_date" type="date" required />
      </label>

      <label>
        有効終了日（空欄で無期限）
        <input name="effective_end_date" type="date" />
      </label>

      <label class="col-span-all">
        引落口座
        <select name="payment_account_id" required>
          {% for a in accounts %}
            <option value="{{ a.id }}">{{ a.name }} (ID:{{ a.id }})</option>
          {% endfor %}
        </select>
      </label>

      <div class="actions col-span-all">
        {% if not accounts %}
          <button class="btn" type="submit" disabled style="opacity:.5;cursor:not-allowed;">カードを追加</button>
        {% else %}
          <button class="btn" type="submit">カードを追加</button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- カード一覧 -->

<div class="card">
  <div class="card-head">
    <h2>カード一覧</h2>
    <button class="btn btn-ghost btn-plus" type="button" data-overlay-open="card-form-template">＋ 追加</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th class="sticky-col" style="width:140px;">操作</th>
          <th style="width:70px;">ID</th>
          <th>カード名</th>
          <th style="width:120px;">締日</th>
          <th style="width:120px;">支払日</th>
          <th style="width:150px;">有効開始日</th>
          <th style="width:170px;">有効終了日</th>
          <th>引落口座</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cards %}
        {% set inactive = c.effective_end_date and c.effective_end_date <= today %}
        <tr data-edit-row class="{% if inactive %}row-inactive{% endif %}">
          <td class="edit-actions sticky-col">
            <button class="btn btn-ghost edit-btn" type="button" data-edit="start">編集</button>
            <form id="card-{{ c.id }}" method="post" action="/cards/{{ c.id }}/update" style="margin:0; display:inline;">
              <button class="btn save-btn" type="submit">保存</button>
            </form>
            <button class="btn btn-ghost cancel-btn" type="button" data-edit="cancel">キャンセル</button>
            <form method="post" action="/cards/{{ c.id }}/delete" style="margin:0; display:inline;">
              <button class="btn btn-danger" type="submit">削除</button>
            </form>
          </td>
          <td>{{ c.id }}</td>
          <td>
            <input class="edit-input" name="name" value="{{ c.name }}" form="card-{{ c.id }}" required />
          </td>
          <td>
            <input class="edit-input" name="closing_day" type="number" min="1" max="31" value="{{ c.closing_day }}" form="card-{{ c.id }}" required />
          </td>
          <td>
            <input class="edit-input" name="payment_day" type="number" min="1" max="31" value="{{ c.payment_day }}" form="card-{{ c.id }}" required />
          </td>
          <td>
            <input class="edit-input" name="effective_start_date" type="date" value="{{ c.effective_start_date.isoformat() if c.effective_start_date else '' }}" form="card-{{ c.id }}" required />
          </td>
          <td>
            <input class="edit-input" name="effective_end_date" type="date" value="{{ c.effective_end_date.isoformat() if c.effective_end_date else '' }}" form="card-{{ c.id }}" />
          </td>
          <td>
            <select class="edit-input" name="payment_account_id" form="card-{{ c.id }}" required>
              {% for a in accounts %}
                <option value="{{ a.id }}" {% if a.id == c.payment_account_id %}selected{% endif %}>{{ a.name }} (ID:{{ a.id }})</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        {% endfor %}

        {% if not cards %}
        <tr><td colspan="8" class="empty">カードがありません。</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="hint mt-10">
    ※ 締日・支払日は月末補正で計算されます。
  </div>
</div>
