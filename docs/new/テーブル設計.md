# テーブル設計（pay_app）
- 最終更新日: 2026-02-18
- 対象プロジェクト: `pay_app`
- 参照実装: `app/models.py`

## 1. 設計方針
- 主キーは `id`（整数）
- 金額は `amount_yen` 系を整数（円）で保持
- 日付は `DATE`、時刻付きは `DateTime`
- 削除は物理削除を基本、予測イベントは再作成可能な構造

## 2. テーブル一覧
- `accounts`
- `plans`
- `subscriptions`
- `cashflow_events`
- `cards`
- `card_transactions`
- `card_statements`
- `card_revolvings`
- `card_installments`
- `import_batches`
- `imported_transactions`

## 3. 主要テーブル
### 3.1 accounts
用途: 資産口座マスタ
- `id` PK
- `name` 口座名
- `kind` 口座種別（bank/cash/barcode/emoney/nisa）
- `balance_yen` 残高（有効開始日時点）
- `effective_start_date` 有効開始日（必須運用）
- `effective_end_date` 有効終了日（NULL=無期限）
- `user_id` 利用者ID（現状は1固定運用）

### 3.2 plans
用途: 定期イベント（収入/定期支払）
- `type` income / subscription
- `title` 表示名
- `amount_yen` 金額
- `account_id` 計上口座
- `payment_method` bank / card
- `card_id` カード払い時のカードID
- `freq` monthly / yearly / monthly_interval
- `day`, `interval_months`, `month`
- `start_date`, `end_date`

### 3.3 subscriptions
用途: サブスク定義
- `name`, `amount_yen`, `billing_day`
- `freq` monthly / yearly / monthly_interval / weekly_interval
- `interval_months`, `interval_weeks`, `billing_month`
- `payment_method` bank / card
- `account_id`, `card_id`

### 3.4 cashflow_events
用途: 予測/登録イベントの実体
- `date`, `amount_yen`, `account_id`
- `plan_id`（plan由来イベント時）
- `description`
- `source`（plan/card/oneoff/transfer など）
- `status`（expected 等）
- `transfer_id`（振替ペア識別）

### 3.5 cards
用途: カードマスタ
- `name`
- `closing_day`, `payment_day`
- `payment_account_id` 引落口座
- `effective_start_date`, `effective_end_date`

### 3.6 card_transactions
用途: カード明細（利用履歴）
- `card_id`, `date`, `amount_yen`
- `merchant`, `note`

### 3.7 card_statements
用途: カード請求集計結果
- `card_id`
- `period_start`, `period_end`
- `amount_yen`, `withdraw_date`
- 一意制約: (`card_id`, `withdraw_date`)

### 3.8 card_revolvings
用途: リボ残高管理
- `card_id`
- `start_month`
- `remaining_yen`
- `monthly_payment_yen`
- `note`

### 3.9 card_installments
用途: 分割払い管理
- `card_id`
- `start_month`
- `months`
- `total_amount_yen`
- `note`

### 3.10 import_batches / imported_transactions
用途: 取込バッチ管理
- 取込元・ステータス・重複判定（fingerprint）を保持

## 4. 注意点
- 外部キーが宣言されていない列（例: `subscriptions.account_id`）はアプリ側検証で整合性を担保する。
- 予測イベントは再生成前提のため、`source` 単位で削除・再作成する。
