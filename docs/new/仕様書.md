# 仕様書（pay_app）
- 最終更新日: 2026-02-18
- 対象プロジェクト: `pay_app`
- 対象読者: 開発者 / テスター / 運用担当

## 1. 目的
`pay_app` は、口座残高・定期予定・カード利用を統合して、月次の資金繰り予測を可視化する家計管理アプリである。

## 2. スコープ
- 口座管理（種別・残高・有効期間）
- 予定管理（収入 / 定期支払）
- サブスク管理（毎月 / 毎年 / nか月 / n週間）
- カード管理（締日・支払日・有効期間）
- カード明細取込（手入力 / CSV / テキスト解析）
- リボ / 分割 / クレカチャージ管理
- 予測イベント再作成と月次予測表示
- 集計可視化（円グラフ・推移）

## 3. 主要機能
### 3.1 口座
- 口座名、残高、種別を登録/編集/削除できる。
- 有効開始日・有効終了日を持ち、予測は有効期間を考慮する。

### 3.2 予定（給料・定期支払）
- 収入/支出を頻度付きで登録できる。
- 頻度は `monthly` / `yearly` / `monthly_interval`。
- カード払い予定はカード請求側へ計上される。

### 3.3 サブスク
- 頻度は `monthly` / `yearly` / `monthly_interval` / `weekly_interval`。
- 支払い方法は口座払い / カード払い。
- カード払いはカード請求に合算される。

### 3.4 カード
- 締日と支払日から請求期間を自動算出する。
- 明細、リボ、分割、チャージを月次請求に計上する。
- カード有効期間外の取引は請求計算対象外。

### 3.5 予測と可視化
- 当月/翌月/翌々月のイベントを再作成できる。
- 総資産予測はマイナス表示を許容し、危険状態をUIで示す。
- 支払内訳、カード店舗内訳、年間コスト内訳を円グラフ表示する。

## 4. 非機能
- FastAPI + SQLAlchemy + SQLite（ローカル運用想定）
- UIはテンプレート + 静的JS/CSS
- 休日/営業日調整ロジックあり（支出は後ろ倒し、収入は前倒し）

## 5. 既知の運用ルール
- カード明細・チャージ更新後は、必要に応じて「イベント再作成」を実行して請求イベントを更新する。
- 本番想定ではマイグレーション管理（Alembic等）を前提とし、軽量マイグレーションは開発補助とする。

## 6. 参照
- `app/main.py`
- `app/models.py`
- `app/services/scheduler.py`
- `app/services/forecast.py`
